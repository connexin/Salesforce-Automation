<apex:page Controller="AccountStatement" docType="html-5.0" tabStyle="Account">
    <apex:form >
        <apex:pageBlock title="Statement Parameters">
            <apex:pageMessages ></apex:pageMessages>
            <apex:pageBlockSection columns="1">
                <!--
                <apex:inputCheckbox value="{! outstandingonly }" title="Show Outstanding Only" label="Show Outstanding Only" >
                    <apex:actionSupport event="onchange" reRender="statement_block"/>
                </apex:inputCheckbox>
                -->
                <apex:input type="date" title="From" label="From" value="{! startdate }" />
                <apex:input type="date" title="To" label="To" value="{! enddate }" />
            </apex:pageBlockSection>
            <apex:pageBlockButtons >
                <apex:commandButton action="{! initStatement }" value="Full Statement"/>
                <apex:commandButton action="{! initStatementOutstandingOnly }" value="Unallocated Only"/>
                <apex:commandButton action="{! takePayment }" value="Take Payment" />
                <apex:commandButton action="{! takeOutstandingPayment }" value="Take Outstanding Balance Payment" rendered="{! lastbalance < 0 }" />
                <apex:commandButton title="Reconcile" action="{! manualReconcile }" value="Reconcile" rendered="{! NOT(account.Auto_Reconcile__c)}"/>
                <apex:commandLink action="{! viewPdf }" target="_blank" style="text-decoration: none">
                    <apex:commandButton value="View PDF" />
                </apex:commandLink>
                <apex:commandButton value="Send Email" action="{! sendEmail }"/>
                <apex:commandButton action="{! cancel }" value="Cancel" />
            </apex:pageBlockButtons>
        </apex:pageBlock>
    </apex:form>
    
    <apex:includeScript value="/support/console/20.0/integration.js"/>
    <script type="text/javascript">
    function testSetTabTitle() {
            //Set the current tab's title
            sforce.console.setTabTitle('{! Account.Name }');
        }
        var pageLoad = window.onload;
        window.onload = function() {
            if (pageLoad) {
                pageLoad();
            }
            testSetTabTitle();
        }
    </script>
    
    <apex:pageBlock title="Account Statement - {! account.Name }" id="statement_block">
        <apex:pageBlockTable title="Statement Details" value="{! sortedList }" var="stmtline" id="statement_table">
            <apex:column headerValue="Date">
                <apex:outputText value="{0,date,dd' 'MMM' - 'yyyy}">
                    <apex:param value="{! stmtline.sortDate }"/>
                </apex:outputText>
            </apex:column>
            <apex:column value="{! stmtline.objectType}" headerValue="Type"/>
            <apex:column headerValue="Reference">
                <apex:outputLink value="/apex/{! if(stmtline.objectType == 'Payment', 'PaymentView', if(stmtline.objectType == 'Refund', 'RefundView', 'FiscalDocumentView')) }?id={!stmtline.objectId}" style="background-color: {! if(stmtline.disputed, '#DC143C', '#FFFFFF')}">{!stmtline.reference}</apex:outputLink>
            </apex:column>
            <apex:column value="{! stmtline.status}" headerValue="Status"/>
            
            <apex:column >
                <apex:facet name="header">
                	<apex:outputPanel >
                    	<apex:outputText value="Debit"/><br/><br/>
                       		<apex:outputText value="Opening Debit {0,number,£#,###,##0.00}">
                           		<apex:param value="{! openingdebit }"/>
                       		</apex:outputText>
                 	</apex:outputPanel>
                </apex:facet>
                <apex:outputText value="{0,number,£#,###,##0.00}" rendered="{! stmtline.debit_amount > 0.00}">
                    <apex:param value="{! if(outstandingOnly == true, stmtline.outstanding_amount, stmtline.debit_amount) }"/>
                    <!--apex:param value="{! stmtline.debit_amount }"/-->
                </apex:outputText>
                <apex:outputText rendered="{! stmtline.debit_amount == 0.00}">-</apex:outputText>
                <apex:facet name="footer">
                    <apex:outputText value="{0,number,£#,###,##0.00}">
                        <apex:param value="{! closingdebit }" />
                    </apex:outputText>
                </apex:facet>
            </apex:column>
            
            <apex:column >
                <apex:facet name="header">
                	<apex:outputPanel >
                    	<apex:outputText value="Credit"/><br/><br/>
                       		<apex:outputText value="Opening Credit {0,number,£#,###,##0.00}">
                           		<apex:param value="{! openingcredit }"/>
                       		</apex:outputText>
                 	</apex:outputPanel>
                </apex:facet>
                <apex:outputText value="{0,number,£#,###,##0.00}" rendered="{! stmtline.credit_amount > 0.00}">
                    <apex:param value="{! if(outstandingOnly == true, stmtline.outstanding_amount, stmtline.credit_amount) }"/>
                    <!--apex:param value="{! stmtline.credit_amount }"/-->
                </apex:outputText>
                <apex:outputText rendered="{! stmtline.credit_amount == 0.00}">-</apex:outputText>
                <apex:facet name="footer">
                    <apex:outputText value="{0,number,£#,###,##0.00}">
                        <apex:param value="{! closingcredit }" />
                    </apex:outputText>
                </apex:facet>
            </apex:column>
                        
            <apex:column >
                <apex:facet name="header">
                    <apex:outputPanel >
                        <apex:outputText value="Balance"/><br/><br/>
                        <apex:outputText value="Opening Balance {0,number,£#,###,##0.00}">
                            <apex:param value="{! initialbalance }"/>
                        </apex:outputText>
                    </apex:outputPanel>
                </apex:facet>
                <apex:outputText value="{0,number,£#,###,##0.00}" style="color:{! If(stmtline.balance_amount > 0, 'red', 'black')}">
                    <apex:param value="{! stmtline.balance_amount }"/>
                </apex:outputText>
                <apex:facet name="footer">
                    <apex:outputText value="{0,number,£#,###,##0.00}">
                        <apex:param value="{! lastbalance }" />
                    </apex:outputText>
                </apex:facet>
            </apex:column>
        </apex:pageBlockTable>
    </apex:pageBlock>
</apex:page>