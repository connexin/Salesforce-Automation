<apex:page standardController="Payment__c" extensions="PaymentController">
    
    <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" />
    
    <apex:sectionHeader title="New Payment" subtitle="Payment Edit" help=""/>
    
    <apex:form >
        <apex:pageBlock title="Payment Details" mode="maindetail">
            <apex:pageBlockButtons location="top">
                <apex:commandButton value="Edit" action="{! edit }" />
                <apex:commandButton value="Delete" action="{! delete }" rendered="{! Payment__c.Draft__c == true }" />
                <apex:commandButton value="Validate" action="{! validateDraft }" rendered="{! Payment__c.Status__c == 'Draft' }"/>
            </apex:pageBlockButtons>
            <apex:pageMessages />
            
            <apex:pageBlockSection >
                <apex:outputField value="{! Payment__c.Account__c }" />
                <apex:outputField value="{! Payment__c.Reference__c }" />
                <apex:outputField value="{! Payment__c.Description__c }" />
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="{! $ObjectType.Payment__c.Fields.Status__c.Label }" />
                    <apex:outputText value="{! Payment__c.Status__c }" style="color: {! IF(Payment__c.Failed__c, 'red', IF(Payment__c.Confirmed__c, 'green', 'orange')) }" />
                </apex:pageBlockSectionItem>
                <apex:outputField value="{! Payment__c.Amount__c }" />
                <apex:outputField value="{! Payment__c.Date__c }" />
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="{! $ObjectType.Payment__c.Fields.Charge_Date__c.Label }" />
                    <apex:outputText value="{0, date, dd'/'MM'/'YYYY}" >
                        <apex:param value="{! Payment__c.Charge_Date__c }" />
                    </apex:outputText>
                </apex:pageBlockSectionItem>
                <apex:outputField value="{! Payment__c.Source__c }" />
            </apex:pageBlockSection>
            
        </apex:pageBlock>
    </apex:form>
    
    <apex:relatedList list="Refunds__r" title="Related Refunds" rendered="{! Payment__c.Confirmed__c }" />
    
    <script type="text/javascript">
    $j = jQuery.noConflict();
    
    $j(document).ready(function() {
        if ({! Payment__c.Amount_Refunded__c == Payment__c.Amount__c }) {
            $j("input[title='New Refund']").hide();
        }
    });
    
    </script>
    
    <apex:pageBlock title="Sales Invoices" rendered="{! NOT(ISBLANK(salesInvoiceRelations)) }">
        <apex:pageBlockTable value="{! salesInvoiceRelations }" var="sales_invoice"  >
            <apex:column >
                <apex:facet name="header">
                    <apex:outputPanel >{! $ObjectType.Fiscal_Document__c.Fields.Reference__c.Label }</apex:outputPanel>
                </apex:facet>
                <apex:outputLink value="{! URLFOR($Action.Fiscal_Document__c.View, sales_invoice.Id, [retURL=URLFOR($Action.Payment__c.View, Payment__c.Id)]) }" >{! sales_invoice.Reference__c }</apex:outputLink>
            </apex:column>
            <apex:column value="{! sales_invoice.Description__c }" />
            <apex:column >
              <apex:facet name="header">
                <apex:outputtext value="Amount Allocated" />
              </apex:facet>
              <apex:outputText value="{0,number,£#,###,###.00}">
                <apex:param value="{! ledgerItems[sales_invoice.Id] }" />
              </apex:outputText>
              <apex:facet name="footer">
                  <apex:outputText value="{0,number,£#,###,###.00}">
                    <apex:param value="{! totalInvoicesAllocated }" />
                  </apex:outputText>
              </apex:facet>
            </apex:column>
            <apex:column value="{! sales_invoice.Subtotal__c }" />
            <apex:column value="{! sales_invoice.Date__c}" />
            <apex:column value="{! sales_invoice.Status__c}" />
        </apex:pageBlockTable>
    </apex:pageBlock>
    
    <apex:pageBlock title="Credit Notes" rendered="{! NOT(ISBLANK(creditNoteRelations)) }">
        <apex:pageBlockTable value="{! creditNoteRelations }" var="credit_note"  >
            <apex:column >
                <apex:facet name="header">
                    <apex:outputPanel >{! $ObjectType.Fiscal_Document__c.Fields.Reference__c.Label }</apex:outputPanel>
                </apex:facet>
                <apex:outputLink value="{! URLFOR($Action.Fiscal_Document__c.View, credit_note.Id, [retURL=URLFOR($Action.Payment__c.View, Payment__c.Id)]) }" >{! credit_note.Reference__c }</apex:outputLink>
            </apex:column>
            <apex:column value="{! credit_note.Description__c }" />
            <apex:column >
              <apex:facet name="header">
                <apex:outputtext value="Amount Allocated" />
              </apex:facet>
              <apex:outputText value="{0,number,£#,###,###.00}">
                <apex:param value="{! ledgerItems[credit_note.Id] }" />
              </apex:outputText>
              <apex:facet name="footer">
                  <apex:outputText value="{0,number,£#,###,###.00}">
                    <apex:param value="{! totalCreditNotesAllocated }" />
                  </apex:outputText>
              </apex:facet>
            </apex:column>
            <apex:column value="{! credit_note.Subtotal__c }" />
            <apex:column value="{! credit_note.Date__c}" />
            <apex:column value="{! credit_note.Status__c}" />
        </apex:pageBlockTable>
    </apex:pageBlock>
    
    <apex:pageBlock title="Payments" rendered="{! NOT(ISBLANK(paymentRelations)) }">
        <apex:pageBlockTable value="{! paymentRelations }" var="payment"  >
            <apex:column >
                <apex:facet name="header">
                    <apex:outputPanel >{! $ObjectType.Payment__c.Fields.Reference__c.Label }</apex:outputPanel>
                </apex:facet>
                <apex:outputLink value="{! URLFOR($Action.Payment__c.View, payment.Id, [retURL=URLFOR($Action.Payment__c.View, Payment__c.Id)]) }" rendered="{! payment.Id != Payment__c.Id }">{! payment.Reference__c }</apex:outputLink>
                <apex:outputText rendered="{! payment.Id == Payment__c.Id }" style="color: #7000ff" value="{! payment.Reference__c }" />
            </apex:column>
            <apex:column style="{! IF(payment.Id = Payment__c.Id, 'color: #7000ff', '') }">
              <apex:facet name="header">
                <apex:outputtext value="Amount Allocated" />
              </apex:facet>
              <apex:outputText value="{0,number,£#,###,###.00}">
                <apex:param value="{! ledgerItems[payment.Id] }" />
              </apex:outputText>
              <apex:facet name="footer">
                  <apex:outputText value="{0,number,£#,###,###.00}">
                    <apex:param value="{! totalPaymentsAllocated }" />
                  </apex:outputText>
              </apex:facet>
            </apex:column>
            <apex:column value="{! payment.Amount__c}" style="{! IF(payment.Id = Payment__c.Id, 'color: #7000ff', '') }" />
            <apex:column value="{! payment.Date__c}" style="{! IF(payment.Id = Payment__c.Id, 'color: #7000ff', '') }" />
            <apex:column value="{! payment.Source__c}" style="{! IF(payment.Id = Payment__c.Id, 'color: #7000ff', '') }" />
            <apex:column value="{! payment.Status__c}" style="{! IF(payment.Id = Payment__c.Id, 'color: #7000ff', '') }" />
        </apex:pageBlockTable>
    </apex:pageBlock>
    
    <apex:pageBlock title="Refunds" rendered="{! NOT(ISBLANK(refundRelations)) }">
        <apex:pageBlockTable value="{! refundRelations }" var="refund"  >
            <apex:column >
                <apex:facet name="header">
                    <apex:outputPanel >{! $ObjectType.Refund__c.Fields.Name.Label }</apex:outputPanel>
                </apex:facet>
                <apex:outputLink value="{! URLFOR($Action.Refund__c.View, refund.Id, [retURL=URLFOR($Action.Payment__c.View, Payment__c.Id)]) }" >{! refund.Name }</apex:outputLink>
            </apex:column>
            <apex:column >
              <apex:facet name="header">
                <apex:outputtext value="Amount Allocated" />
              </apex:facet>
              <apex:outputText value="{0,number,£#,###,###.00}">
                <apex:param value="{! ledgerItems[refund.Id] }" />
              </apex:outputText>
              <apex:facet name="footer">
                  <apex:outputText value="{0,number,£#,###,###.00}">
                    <apex:param value="{! totalRefundsAllocated }" />
                  </apex:outputText>
              </apex:facet>
            </apex:column>
            <apex:column value="{! refund.Amount__c}" />
            <apex:column value="{! refund.Date__c}" />
            <apex:column value="{! refund.Status__c}" />
        </apex:pageBlockTable>
    </apex:pageBlock>
    
    <apex:pageBlock title="Reconciliations" rendered="{! AND(false, NOT(ISBLANK(reconciliationRelations))) }">
        <apex:pageBlockTable value="{! reconciliationRelations }" var="reconciliation"  >
            <apex:column >
                <apex:facet name="header">
                    <apex:outputPanel >{! $ObjectType.Reconciliation__c.Fields.Name.Label }</apex:outputPanel>
                </apex:facet>
                <apex:outputLink value="{! URLFOR($Action.Reconciliation__c.View, reconciliation.Id, [retURL=URLFOR($Action.Payment__c.View, Payment__c.Id)]) }" >{! reconciliation.Name }</apex:outputLink>
            </apex:column>
            <apex:column value="{! reconciliation.Credits__c }" />
            <apex:column value="{! reconciliation.Debits__c }" />
            <apex:column value="{! reconciliation.Reconciled__c }" />
        </apex:pageBlockTable>
    </apex:pageBlock>
    
    <apex:includeScript value="/support/console/20.0/integration.js"/>
    <script type="text/javascript">
        function testSetTabTitle() {
            //Set the current tab's title
            sforce.console.setTabTitle('Payment: {! Payment__c.Reference__c }');
        }
        var pageLoad = window.onload;
        window.onload = function() {
            if (pageLoad) {
                pageLoad();
            }
            testSetTabTitle();
        }
    </script>
    
</apex:page>